# SCM 供应链管理系统 - 数据库说明文档

## 一、数据库概述

### 1.1 数据库类型
- **数据库系统**: MySQL 8.4
- **字符集**: utf8mb4
- **排序规则**: utf8mb4_unicode_ci

### 1.2 连接信息

| 配置项 | 值 | 说明 |
|--------|-----|------|
| 主机地址 | localhost | 本地开发环境 |
| 端口 | 3306 | MySQL 默认端口 |
| 用户名 | root | 数据库管理员 |
| 密码 | 123456 | 开发环境密码 |
| 数据库名 | scm_db | 供应链管理数据库 |

### 1.3 连接字符串

```
mysql+pymysql://root:123456@localhost:3306/scm_db?charset=utf8mb4
```

---

## 二、数据表结构

### 2.1 用户权限模块

#### users（用户表）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT | 主键，自增 |
| username | VARCHAR(50) | 用户名，唯一 |
| password | VARCHAR(255) | 密码（bcrypt加密） |
| real_name | VARCHAR(50) | 真实姓名 |
| email | VARCHAR(100) | 邮箱 |
| phone | VARCHAR(20) | 手机号 |
| avatar | VARCHAR(255) | 头像URL |
| status | BOOLEAN | 状态：True-启用，False-禁用 |
| department_id | INT | 部门ID（外键） |
| is_superuser | BOOLEAN | 是否超级管理员 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

#### roles（角色表）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT | 主键，自增 |
| name | VARCHAR(50) | 角色名称 |
| code | VARCHAR(50) | 角色编码，唯一 |
| description | TEXT | 角色描述 |
| status | BOOLEAN | 状态 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

#### permissions（权限表）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT | 主键，自增 |
| name | VARCHAR(50) | 权限名称 |
| code | VARCHAR(100) | 权限编码，唯一 |
| type | VARCHAR(20) | 权限类型：menu/button/api |
| description | TEXT | 权限描述 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

#### user_roles（用户角色关联表）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT | 主键，自增 |
| user_id | INT | 用户ID（外键） |
| role_id | INT | 角色ID（外键） |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

#### role_permissions（角色权限关联表）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT | 主键，自增 |
| role_id | INT | 角色ID（外键） |
| permission_id | INT | 权限ID（外键） |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

#### departments（部门表）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT | 主键，自增 |
| name | VARCHAR(100) | 部门名称 |
| code | VARCHAR(50) | 部门编码，唯一 |
| parent_id | INT | 父部门ID（外键） |
| sort_order | INT | 排序 |
| leader | VARCHAR(50) | 负责人 |
| phone | VARCHAR(20) | 联系电话 |
| address | VARCHAR(255) | 地址 |
| description | TEXT | 部门描述 |
| status | INT | 状态：1-启用，0-禁用 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

---

### 2.2 供应商客户模块

#### suppliers（供应商表）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT | 主键，自增 |
| code | VARCHAR(50) | 供应商编码，唯一 |
| name | VARCHAR(200) | 供应商名称 |
| type | VARCHAR(20) | 类型：manufacturer/distributor/other |
| contact_person | VARCHAR(50) | 联系人 |
| contact_phone | VARCHAR(20) | 联系电话 |
| contact_email | VARCHAR(100) | 联系邮箱 |
| address | VARCHAR(255) | 地址 |
| tax_number | VARCHAR(50) | 税号 |
| bank_name | VARCHAR(100) | 开户银行 |
| bank_account | VARCHAR(50) | 银行账号 |
| credit_level | VARCHAR(20) | 信用等级：A/B/C/D |
| credit_limit | FLOAT | 信用额度 |
| balance | FLOAT | 余额 |
| status | BOOLEAN | 状态 |
| remark | TEXT | 备注 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

#### customers（客户表）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT | 主键，自增 |
| code | VARCHAR(50) | 客户编码，唯一 |
| name | VARCHAR(200) | 客户名称 |
| type | VARCHAR(20) | 类型：normal/vip/wholesale/retail |
| contact_person | VARCHAR(50) | 联系人 |
| contact_phone | VARCHAR(20) | 联系电话 |
| contact_email | VARCHAR(100) | 联系邮箱 |
| address | VARCHAR(255) | 地址 |
| tax_number | VARCHAR(50) | 税号 |
| bank_name | VARCHAR(100) | 开户银行 |
| bank_account | VARCHAR(50) | 银行账号 |
| credit_limit | FLOAT | 信用额度 |
| balance | FLOAT | 余额 |
| status | BOOLEAN | 状态 |
| remark | TEXT | 备注 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

---

### 2.3 库存管理模块

#### products（产品表）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT | 主键，自增 |
| code | VARCHAR(50) | 产品编码，唯一 |
| name | VARCHAR(200) | 产品名称 |
| category_id | INT | 分类ID（外键） |
| specification | VARCHAR(100) | 规格型号 |
| unit | VARCHAR(20) | 单位 |
| purchase_price | FLOAT | 采购价 |
| sale_price | FLOAT | 销售价 |
| min_stock | FLOAT | 最小库存 |
| max_stock | FLOAT | 最大库存 |
| current_stock | FLOAT | 当前库存 |
| status | VARCHAR(20) | 状态：active/inactive |
| remark | TEXT | 备注 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

#### product_categories（产品分类表）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT | 主键，自增 |
| name | VARCHAR(100) | 分类名称 |
| code | VARCHAR(50) | 分类编码，唯一 |
| parent_id | INT | 父分类ID（外键） |
| sort_order | INT | 排序 |
| description | TEXT | 描述 |
| status | INT | 状态 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

#### warehouses（仓库表）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT | 主键，自增 |
| code | VARCHAR(50) | 仓库编码，唯一 |
| name | VARCHAR(100) | 仓库名称 |
| type | VARCHAR(20) | 类型：normal/raw/finished/return |
| address | VARCHAR(255) | 地址 |
| manager | VARCHAR(50) | 负责人 |
| phone | VARCHAR(20) | 联系电话 |
| capacity | FLOAT | 容量 |
| status | INT | 状态 |
| remark | TEXT | 备注 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

#### stock_records（库存记录表）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT | 主键，自增 |
| code | VARCHAR(50) | 出入库单号，唯一 |
| type | VARCHAR(20) | 类型：in/out/transfer/check/adjust |
| warehouse_id | INT | 仓库ID（外键） |
| product_id | INT | 产品ID（外键） |
| quantity | FLOAT | 数量 |
| unit_price | FLOAT | 单价 |
| amount | FLOAT | 金额 |
| reference_code | VARCHAR(50) | 关联单号 |
| reference_type | VARCHAR(20) | 关联类型：purchase/sale/transfer |
| operator_id | INT | 操作人ID（外键） |
| remark | TEXT | 备注 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

#### stock_checks（盘点单表）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT | 主键，自增 |
| code | VARCHAR(50) | 盘点单号，唯一 |
| warehouse_id | INT | 仓库ID（外键） |
| check_date | DATETIME | 盘点日期 |
| status | VARCHAR(20) | 状态：pending/completed |
| operator_id | INT | 盘点人ID（外键） |
| remark | TEXT | 备注 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

#### stock_check_items（盘点明细表）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT | 主键，自增 |
| stock_check_id | INT | 盘点单ID（外键） |
| product_id | INT | 产品ID（外键） |
| book_quantity | FLOAT | 账面数量 |
| actual_quantity | FLOAT | 实际数量 |
| diff_quantity | FLOAT | 差异数量 |
| remark | TEXT | 备注 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

---

### 2.4 采购管理模块

#### purchase_orders（采购订单表）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT | 主键，自增 |
| code | VARCHAR(50) | 采购单号，唯一 |
| supplier_id | INT | 供应商ID（外键） |
| purchase_date | DATETIME | 采购日期 |
| expected_date | DATETIME | 预计到货日期 |
| total_amount | FLOAT | 总金额 |
| paid_amount | FLOAT | 已付金额 |
| status | VARCHAR(20) | 状态：pending/approved/shipped/completed/cancelled |
| approval_status | VARCHAR(20) | 审批状态：pending/approved/rejected |
| approved_by | INT | 审批人ID（外键） |
| approved_at | DATETIME | 审批时间 |
| remark | TEXT | 备注 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

#### purchase_order_items（采购订单明细表）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT | 主键，自增 |
| purchase_order_id | INT | 采购单ID（外键） |
| product_code | VARCHAR(50) | 产品编码 |
| product_name | VARCHAR(200) | 产品名称 |
| specification | VARCHAR(100) | 规格型号 |
| unit | VARCHAR(20) | 单位 |
| quantity | FLOAT | 数量 |
| unit_price | FLOAT | 单价 |
| amount | FLOAT | 金额 |
| received_quantity | FLOAT | 已收货数量 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

---

### 2.5 销售管理模块

#### sales_orders（销售订单表）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT | 主键，自增 |
| code | VARCHAR(50) | 销售单号，唯一 |
| customer_id | INT | 客户ID（外键） |
| sale_date | DATETIME | 销售日期 |
| delivery_date | DATETIME | 交货日期 |
| total_amount | FLOAT | 总金额 |
| paid_amount | FLOAT | 已付金额 |
| status | VARCHAR(20) | 状态：pending/shipped/delivered/completed/cancelled |
| approval_status | VARCHAR(20) | 审批状态：pending/approved/rejected |
| approved_by | INT | 审批人ID（外键） |
| approved_at | DATETIME | 审批时间 |
| remark | TEXT | 备注 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

#### sales_order_items（销售订单明细表）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT | 主键，自增 |
| sales_order_id | INT | 销售单ID（外键） |
| product_code | VARCHAR(50) | 产品编码 |
| product_name | VARCHAR(200) | 产品名称 |
| specification | VARCHAR(100) | 规格型号 |
| unit | VARCHAR(20) | 单位 |
| quantity | FLOAT | 数量 |
| unit_price | FLOAT | 单价 |
| amount | FLOAT | 金额 |
| shipped_quantity | FLOAT | 已发货数量 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

---

### 2.6 财务管理模块

#### accounts（账户表）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT | 主键，自增 |
| name | VARCHAR(100) | 账户名称 |
| code | VARCHAR(50) | 账户编码，唯一 |
| type | VARCHAR(20) | 类型：bank/cash/online |
| bank_name | VARCHAR(100) | 开户银行 |
| account_number | VARCHAR(50) | 账号 |
| balance | FLOAT | 余额 |
| status | INT | 状态 |
| remark | TEXT | 备注 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

#### payments（付款记录表）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT | 主键，自增 |
| code | VARCHAR(50) | 付款单号，唯一 |
| type | VARCHAR(20) | 类型：pay/receive |
| amount | FLOAT | 金额 |
| payment_method | VARCHAR(20) | 付款方式：cash/transfer/check/online |
| payment_date | DATETIME | 付款日期 |
| reference_code | VARCHAR(50) | 关联单号 |
| reference_type | VARCHAR(20) | 关联类型：purchase/sale/other |
| supplier_id | INT | 供应商ID（外键） |
| customer_id | INT | 客户ID（外键） |
| bank_account | VARCHAR(50) | 银行账号 |
| status | VARCHAR(20) | 状态：pending/completed/cancelled |
| approval_status | VARCHAR(20) | 审批状态：pending/approved/rejected |
| approved_by | INT | 审批人ID（外键） |
| approved_at | DATETIME | 审批时间 |
| operator_id | INT | 操作人ID（外键） |
| remark | TEXT | 备注 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

#### bills（账单表）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT | 主键，自增 |
| code | VARCHAR(50) | 单据号，唯一 |
| type | VARCHAR(20) | 类型：receivable/payable |
| amount | FLOAT | 金额 |
| bill_date | DATETIME | 单据日期 |
| due_date | DATETIME | 到期日期 |
| reference_code | VARCHAR(50) | 关联单号 |
| reference_type | VARCHAR(20) | 关联类型 |
| supplier_id | INT | 供应商ID（外键） |
| customer_id | INT | 客户ID（外键） |
| paid_amount | FLOAT | 已付金额 |
| remaining_amount | FLOAT | 剩余金额 |
| status | VARCHAR(20) | 状态：unpaid/partial/paid/overdue |
| remark | TEXT | 备注 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

#### cost_centers（成本中心表）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT | 主键，自增 |
| name | VARCHAR(100) | 成本中心名称 |
| code | VARCHAR(50) | 编码，唯一 |
| parent_id | INT | 父级ID（外键） |
| description | TEXT | 描述 |
| status | INT | 状态 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

---

### 2.7 工作流模块

#### workflow_definitions（工作流定义表）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT | 主键，自增 |
| name | VARCHAR(100) | 流程名称 |
| code | VARCHAR(50) | 流程编码，唯一 |
| type | VARCHAR(50) | 流程类型：purchase/sale/payment/other |
| description | TEXT | 描述 |
| status | INT | 状态 |
| config | JSON | 流程配置JSON |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

#### workflow_instances（工作流实例表）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT | 主键，自增 |
| code | VARCHAR(50) | 实例编号，唯一 |
| definition_id | INT | 流程定义ID（外键） |
| business_type | VARCHAR(50) | 业务类型 |
| business_id | INT | 业务ID |
| current_step | VARCHAR(50) | 当前步骤 |
| status | VARCHAR(20) | 状态：pending/approved/rejected/cancelled |
| initiator_id | INT | 发起人ID（外键） |
| remark | TEXT | 备注 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

#### workflow_logs（工作流日志表）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT | 主键，自增 |
| instance_id | INT | 实例ID（外键） |
| step_name | VARCHAR(50) | 步骤名称 |
| action | VARCHAR(20) | 操作：submit/approve/reject/cancel |
| handler_id | INT | 处理人ID（外键） |
| comment | TEXT | 审批意见 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

---

## 三、ER关系图

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户权限模块                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌──────────┐     ┌──────────────┐     ┌──────────────┐       │
│   │  users   │────<│  user_roles  │>────│    roles     │       │
│   └────┬─────┘     └──────────────┘     └──────┬───────┘       │
│        │                                        │               │
│        │            ┌──────────────────┐        │               │
│        │            │role_permissions  │        │               │
│        │            └────────┬─────────┘        │               │
│        │                     │                  │               │
│        ▼                     ▼                  ▼               │
│   ┌──────────────┐     ┌──────────────┐                         │
│   │ departments  │     │ permissions  │                         │
│   └──────────────┘     └──────────────┘                         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                        业务数据模块                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌────────────┐     ┌─────────────────┐     ┌──────────────┐  │
│   │ suppliers  │────<│ purchase_orders │>────│   products   │  │
│   └────────────┘     └─────────────────┘     └──────────────┘  │
│                              │                        │         │
│                              ▼                        ▼         │
│                      ┌───────────────────┐    ┌─────────────┐   │
│                      │purchase_order_items│    │ warehouses  │   │
│                      └───────────────────┘    └──────┬──────┘   │
│                                                       │          │
│   ┌────────────┐     ┌─────────────────┐             │          │
│   │ customers  │────<│  sales_orders   │             │          │
│   └────────────┘     └─────────────────┘             │          │
│                              │                        ▼          │
│                              ▼              ┌─────────────────┐ │
│                      ┌───────────────────┐  │  stock_records  │ │
│                      │ sales_order_items │  └─────────────────┘ │
│                      └───────────────────┘                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                        财务管理模块                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌────────────┐     ┌──────────────┐     ┌───────────────┐    │
│   │  accounts  │<────│   payments   │────>│ suppliers/    │    │
│   └────────────┘     └──────────────┘     │ customers     │    │
│                      ┌──────────────┐      └───────────────┘    │
│                      │    bills     │                            │
│                      └──────────────┘                            │
│                      ┌──────────────┐                            │
│                      │ cost_centers │                            │
│                      └──────────────┘                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 四、初始化脚本

### 4.1 数据库初始化

```bash
# 进入 backend 目录
cd d:\project\SCM\backend

# 初始化数据库和表结构
.\venv\Scripts\python init_mysql.py

# 初始化测试数据
.\venv\Scripts\python init_test_data.py
```

### 4.2 手动创建数据库

```sql
CREATE DATABASE IF NOT EXISTS scm_db 
DEFAULT CHARACTER SET utf8mb4 
COLLATE utf8mb4_unicode_ci;
```

---

## 五、备份与恢复

### 5.1 备份数据库

```bash
# 使用 mysqldump 备份
"C:\Program Files\MySQL\MySQL Server 8.4\bin\mysqldump.exe" -u root -p123456 scm_db > scm_db_backup.sql

# 备份文件命名：scm_db_YYYYMMDD.sql
```

### 5.2 恢复数据库

```bash
# 使用 mysql 恢复
"C:\Program Files\MySQL\MySQL Server 8.4\bin\mysql.exe" -u root -p123456 scm_db < scm_db_backup.sql
```

---

## 六、常用查询

### 6.1 查看所有表

```sql
SHOW TABLES;
```

### 6.2 查看表结构

```sql
DESCRIBE users;
-- 或
SHOW CREATE TABLE users;
```

### 6.3 查看数据统计

```sql
-- 用户统计
SELECT COUNT(*) AS user_count FROM users;

-- 订单统计
SELECT 
    (SELECT COUNT(*) FROM purchase_orders) AS purchase_orders,
    (SELECT COUNT(*) FROM sales_orders) AS sales_orders;

-- 库存统计
SELECT 
    p.name,
    p.current_stock,
    p.unit,
    w.name AS warehouse_name
FROM products p
LEFT JOIN stock_records sr ON p.id = sr.product_id
LEFT JOIN warehouses w ON sr.warehouse_id = w.id
GROUP BY p.id;
```

---

## 七、配置文件

### 7.1 环境变量配置（.env）

```env
# MySQL 数据库配置
MYSQL_HOST=localhost
MYSQL_PORT=3306
MYSQL_USER=root
MYSQL_PASSWORD=123456
MYSQL_DATABASE=scm_db

# 安全密钥（生产环境请修改）
SECRET_KEY=your-secret-key-change-in-production-2024

# Redis配置
REDIS_URL=redis://localhost:6379/0
```

### 7.2 应用配置（app/core/config.py）

数据库连接字符串通过环境变量自动生成：

```python
DATABASE_URL = "mysql+pymysql://root:123456@localhost:3306/scm_db?charset=utf8mb4"
```

---

## 八、注意事项

1. **生产环境安全**
   - 修改默认的 root 密码
   - 创建专用数据库用户，限制权限
   - 修改 SECRET_KEY 为复杂随机字符串

2. **性能优化**
   - 为常用查询字段添加索引
   - 定期清理历史日志数据
   - 配置 MySQL 查询缓存

3. **数据备份**
   - 建议每日自动备份
   - 备份文件异地存储
   - 定期测试恢复流程

---

*文档版本: 1.0*  
*更新日期: 2026-02-13*  
*适用系统: SCM 供应链管理系统*
